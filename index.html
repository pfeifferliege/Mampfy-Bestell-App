<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mampfy Crazy Mexican - Bestell-App</title>
    
    <link rel="icon" href="data:;base64,="> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Custom styles for the app's aesthetics (Dark Mode) */
        :root {
            --primary-color: #e53e3e; 
            --secondary-color: #38a169; 
            --whatsapp-green: #25D366; 
            --bg-dark: #1a202c; 
            --card-dark: #2d3748; 
            --input-dark: #4a5568; 
            --text-light: #ffffff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
        }
        .container-card {
            background-color: var(--card-dark);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        .input-style {
            background-color: var(--input-dark);
            border-color: var(--input-dark);
            color: var(--text-light);
            appearance: none; 
        }
        .btn-whatsapp {
            background-color: var(--whatsapp-green);
            transition: background-color 0.2s;
        }
        .btn-whatsapp:hover {
            background-color: #128C7E;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #2f855a;
        }
        
        .order-items-container::-webkit-scrollbar {
            width: 8px;
        }
        .order-items-container::-webkit-scrollbar-track {
            background: #4a5568;
        }
        .order-items-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        .btn-share {
            background-color: #1D9BF0; 
            transition: background-color 0.2s;
        }
        .btn-share:hover {
            background-color: #1781c9;
        }

        /* Stil fÃ¼r Radio-Buttons */
        .radio-label {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: var(--input-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .radio-label:hover {
            background-color: #3f4757;
        }
        input[type="radio"]:checked + .radio-label {
            border-color: var(--primary-color);
            background-color: #3f4757;
        }
        /* MODAL (Pop-up) Styles */
        #paypal-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #modal-content {
            background-color: var(--card-dark);
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        .paypal-link-display {
            background-color: #4a5568;
            padding: 10px;
            border-radius: 6px;
            word-wrap: break-word;
            font-size: 0.9em;
            color: #ffda79;
        }
        .test-mode-warning {
             background-color: #ffda79;
             color: #1a202c;
             padding: 8px;
             border-radius: 4px;
             font-weight: bold;
             margin-bottom: 15px;
             text-align: center;
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="container-card w-full max-w-4xl p-6 md:p-10 rounded-xl">
            <h1 class="text-3xl font-extrabold text-center mb-6 text-yellow-400">
                ðŸŒ¯ Mampfy Crazy Mexican - Bestellung
            </h1>
            
            <div id="new-customer-banner" class="p-3 mb-6 bg-red-600 rounded-lg text-center font-bold text-white shadow-lg hidden">
                ðŸ¥³ Willkommen! Als Neukunde erhalten Sie 1,50 â‚¬ Rabatt auf diese Bestellung!
            </div>

            <section id="personal-data" class="mb-8 p-4 border border-gray-700 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-300">1. Ihre Kontaktdaten</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="name" placeholder="Name" class="p-3 rounded-lg input-style focus:ring-red-500 focus:border-red-500" required>
                    <input type="tel" id="phone" placeholder="Telefonnummer (fÃ¼r WhatsApp)" class="p-3 rounded-lg input-style focus:ring-red-500 focus:border-red-500" required>
                </div>
            </section>

            <section id="order-section" class="mb-8 p-4 border border-gray-700 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-300">2. Ihre Speisen</h2>
                
                <div id="order-items-container" class="order-items-container space-y-4 max-h-96 overflow-y-auto pr-2 mb-4">
                    </div>

                <div class="flex flex-col md:flex-row items-center justify-between mt-4">
                    <button id="add-dish-btn" class="w-full md:w-auto px-6 py-3 btn-secondary rounded-lg font-semibold shadow-md mb-4 md:mb-0" onclick="addDish()">
                        + Speise hinzufÃ¼gen
                    </button>
                    
                    <div class="w-full md:w-1/3">
                        <label for="pickup-time" class="block text-sm font-medium mb-1 text-gray-400">GewÃ¼nschte Abholzeit: <span class="text-red-500">*</span></label>
                        <input type="time" id="pickup-time" class="p-3 rounded-lg input-style w-full focus:ring-red-500 focus:border-red-500" value="" required>
                    </div>
                </div>
            </section>
            
            <section id="payment-section" class="mb-8 p-4 border border-gray-700 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-300">3. Bezahlmethode <span class="text-red-500">*</span></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <input type="radio" id="pay-cash" name="payment-method" value="Barzahlung" class="hidden" required checked>
                        <label for="pay-cash" class="radio-label">
                            <span class="mr-3 text-2xl">ðŸ’°</span>
                            <span class="font-semibold">Barzahlung bei Abholung</span>
                        </label>
                    </div>
                    <div>
                        <input type="radio" id="pay-paypal" name="payment-method" value="PayPal" class="hidden" required>
                        <label for="pay-paypal" class="radio-label">
                            <span class="mr-3 text-2xl">ðŸ’³</span>
                            <span class="font-semibold">PayPal (Vorkasse)</span>
                        </label>
                    </div>
                </div>
            </section>


            <section id="receipt-section" class="mb-8 p-4 border border-gray-700 rounded-lg bg-gray-800">
                <h2 class="text-xl font-bold mb-4 text-yellow-400">4. Ihre Rechnung</h2>
                <div id="receipt-details" class="space-y-2 text-sm text-gray-200">
                    <p class="text-center italic text-gray-400">Noch keine Artikel in der Bestellung.</p>
                </div>
                
                <div id="receipt-subtotal" class="mt-4 pt-4 border-t border-gray-600 font-normal text-md flex justify-between text-gray-400">
                    <span>Zwischensumme:</span>
                    <span id="sub-total-price">0,00 â‚¬</span>
                </div>
                 <div id="receipt-discount" class="font-normal text-md flex justify-between text-red-400" style="display: none;">
                    <span>Rabatt (Neukunde):</span>
                    <span id="discount-amount">0,00 â‚¬</span>
                </div>

                <div id="receipt-total" class="mt-2 pt-2 border-t border-gray-600 font-bold text-lg flex justify-between text-yellow-300">
                    <span>Zahlen (Endsumme):</span>
                    <span id="total-price">0,00 â‚¬</span>
                </div>
                
                <div id="receipt-time" class="pt-2 text-sm flex justify-between text-gray-400">
                    <span>Abholzeit:</span>
                    <span id="display-pickup-time">Bitte auswÃ¤hlen</span>
                </div>
                <div id="receipt-payment" class="pt-1 text-sm flex justify-between text-gray-400">
                    <span>Bezahlung:</span>
                    <span id="display-payment-method">Barzahlung</span>
                </div>

            </section>
            
            <section id="action-section" class="p-4 border border-gray-700 rounded-lg">
                <h2 class="text-xl font-bold mb-4 text-gray-300">5. Bestellung absenden</h2>
                <div class="grid grid-cols-1 gap-4">
                    <button id="send-order-btn" class="flex items-center justify-center w-full px-6 py-4 btn-whatsapp rounded-lg font-semibold shadow-md text-white transition-transform transform hover:scale-[1.01]" onclick="handleOrderSubmission()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C6.54 2 2.08 6.47 2.08 11.97c0 1.63.4 3.23 1.18 4.67l-1.22 4.45 4.65-1.21c1.37.74 2.87 1.14 4.35 1.14 5.49 0 9.95-4.47 9.95-9.97C22 6.47 17.54 2 12.04 2zm5.82 14.86c-.19.46-.73.69-1.22.69-2.09 0-4.18-.74-5.82-2.22-.38-.34-.73-.72-1.04-1.12l-1.55-2.02c-.14-.19-.36-.26-.54-.18l-1.01.4c-.1.04-.13.06-.17.06-.21 0-.39-.12-.39-.34 0-1.78 1.4-3.2 3.1-3.2h.15c.19 0 .36.14.4.31l.5.76c.04.08.11.12.18.12.06 0 .12-.04.16-.08l1.09-1.34c.14-.17.39-.22.56-.13l1.83.95c.17.08.36.03.48-.1L17 11.44c.14-.19.1-.42-.1-.52l-1.7-1.1c-.2-.1-.4-.14-.62-.06l-1.46.36c-.19.04-.32-.05-.4-.22l-.46-1.12c-.08-.17-.25-.26-.44-.26h-.03c-2.47 0-4.48 2.01-4.48 4.48 0 1.2.47 2.37 1.34 3.22 1.45 1.3 3.14 1.94 4.88 1.94.85 0 1.63-.16 2.36-.5.19-.09.28-.3.2-.5z"/></svg>
                        Per WhatsApp senden (Barzahlung)
                    </button>
                </div>
                <p id="message-box" class="mt-4 p-3 text-white rounded-lg hidden text-center"></p>
            </section>
            
            <section id="share-section" class="mt-6 p-4 border border-gray-700 rounded-lg bg-gray-800">
                <h3 class="text-lg font-bold mb-3 text-gray-400">App teilen</h3>
                <p class="text-sm text-gray-400 mb-4">
                    Empfehlen Sie unsere App und unseren 1,50 â‚¬ Neukunden-Rabatt weiter!
                </p>
                <button class="flex items-center justify-center w-full px-6 py-3 btn-share rounded-lg font-semibold shadow-md text-white transition-transform transform hover:scale-[1.01]" onclick="shareApp()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 8a2 2 0 100 4h-1.586l-2.707 2.707a1 1 0 01-1.414 0L10.586 13H5a2 2 0 00-2 2v2a2 2 0 104 0v-2h2.586l1.293 1.293a1 1 0 001.414 0l2.707-2.707H18a4 4 0 00-4-4h-1.586l-2.707-2.707a1 1 0 00-1.414 0L5.414 7H2a2 2 0 00-2 2v2a2 2 0 104 0V9h2.586L9.293 6.707a1 1 0 000-1.414l-2.707-2.707H0a2 2 0 100 4h1.586l2.707 2.707a1 1 0 001.414 0l1.293-1.293H13a2 2 0 002-2V7h1.586l-2.707-2.707a1 1 0 000-1.414l-1.293-1.293H4a2 2 0 10-4 0v2a2 2 0 104 0V5h1.586l2.707 2.707a1 1 0 001.414 0l2.707-2.707H18a2 2 0 10-4 0v2a2 2 0 104 0V9z" clip-rule="evenodd" />
                    </svg>
                    App teilen (via Web Share)
                </button>
            </section>


            <p class="text-xs text-center mt-6 text-gray-500">
                Â© Mampfy Crazy Mexican-Blankenburg 2025
            </p>
        </div>
    </div>

    <div id="paypal-modal">
        <div id="modal-content">
            <div id="test-mode-info" class="test-mode-warning" style="display: none;">
                âš  TEST-MODUS AKTIV: Der Link dient nur der ÃœberprÃ¼fung, keine Zahlung wird ausgefÃ¼hrt.
            </div>

            <h3 class="text-xl font-bold mb-4 text-red-500">ðŸ’³ PayPal-Zahlung erforderlich!</h3>
            <p class="mb-4">Bitte klicken Sie auf den Link, um <strong id="modal-total-price">0,00 â‚¬</strong> zu bezahlen. Ihre Bestellung wird erst nach diesem Schritt gesendet.</p>
            
            <a id="paypal-link" href="#" target="_blank" class="block w-full text-center p-3 mb-4 bg-yellow-500 text-gray-900 font-bold rounded-lg hover:bg-yellow-400">
                PayPal-Zahlung starten
            </a>

            <div class="paypal-link-display mb-4 text-sm">
                <span class="font-bold">Link (zur Sicherheit):</span> <span id="modal-link-display"></span>
            </div>

            <p class="text-sm text-gray-400 mb-6">
                Nach erfolgreicher Zahlung kehren Sie bitte hierher zurÃ¼ck und bestÃ¤tigen:
            </p>

            <button id="confirm-paypal-btn" class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md" onclick="sendOrderViaWhatsApp('PayPal')">
                Zahlung abgeschlossen & Bestellung senden
            </button>
            
            <button class="w-full mt-3 px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-md" onclick="sendOrderViaWhatsApp('Barzahlung_Fallback')">
                Abbrechen: Stattdessen Barzahlung senden
            </button>

        </div>
    </div>


    <script>
        const PRODUCTS = [
            { id: 'b1', name: 'MEXICAN BEEF CHEESE BURRITO', price: 14.50, emoji: 'ðŸŒ¯' },
            { id: 'b2', name: 'PULLED PORK CHEESE BURRITO', price: 14.50, emoji: 'ðŸŒ¯' },
            { id: 'b3', name: 'MEXICAN SMOKED TOFU BURRITO (VEGAN)', price: 14.50, emoji: 'ðŸŒ¯' },
            { id: 'q1', name: 'CHEESE QUESADILLA', price: 7.50, emoji: 'ðŸŒ®' },
            { id: 'p1', name: 'MEXICAN CHEESE POTATOES', price: 7.50, emoji: 'ðŸ¥”' },
            { id: 'p2', name: 'MEXICAN PULLED PORK CHEESE POTATOES', price: 10.00, emoji: 'ðŸ¥”' },
            { id: 'p3', name: 'MEXICAN BEEF CHEESE POTATOES', price: 10.00, emoji: 'ðŸ¥”' },
            { id: 'p4', name: 'MEXICAN CHICKEN CHEESE POTATOES', price: 10.00, emoji: 'ðŸ¥”' },
            { id: 'b4', name: 'MEXICAN CHICKEN CHEESE BURRITO', price: 14.50, emoji: 'ðŸŒ¯' },
            { id: 'p5', name: 'MEXICAN SMOKET TOFU POTATOES (VEGAN)', price: 10.00, emoji: 'ðŸ¥”' },
            { id: 'bg1', name: 'PULLED PORK BURGER', price: 12.00, emoji: 'ðŸ”' }
        ];

        let orderItemCounter = 0;
        const phoneRecipient = '4915234392083'; 
        const NEW_CUSTOMER_FLAG = 'mampfy_is_new_customer';
        const DISCOUNT_AMOUNT = 1.50; 
        const SHARE_URL = 'https://eu.jotform.com/app/253415036626353'; 
        
        // HINWEIS: BITTE DIESEN WERT DURCH IHREN ECHTEN PAYPAL.ME NAMEN ERSETZEN (z.B. 'mampfymexican')!
        // Wenn dieser Wert 'TEST_MODE_DEAKTIVIERT' ist, wird der Test-Link verwendet.
        const PAYPAL_ME_NAME = 'TEST_MODE_DEAKTIVIERT'; 
        const PAYPAL_TEST_LINK_BASE = 'https://example.com/test-payment/'; // Harmloser Test-Link

        /**
         * PrÃ¼ft, ob der Neukunden-Rabatt aktiv sein soll.
         */
        function isNewCustomer() {
            return localStorage.getItem(NEW_CUSTOMER_FLAG) === null;
        }

        /**
         * Zeigt eine temporÃ¤re Nachricht im Nachrichtenfeld an.
         */
        function showMessage(message, type = 'error') {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = `mt-4 p-3 rounded-lg text-center ${type === 'success' ? 'bg-green-700' : 'bg-red-700'} text-white`;
            msgBox.style.display = 'block';
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 5000);
        }

        /**
         * FÃ¼gt eine neue Bestellposition zur Bestellung hinzu.
         */
        function addDish() {
            orderItemCounter++;
            const container = document.getElementById('order-items-container');
            
            const itemRow = document.createElement('div');
            itemRow.className = 'flex items-center space-x-2 p-2 bg-gray-700 rounded-lg shadow';
            itemRow.id = `item-row-${orderItemCounter}`;
            
            const select = document.createElement('select');
            select.id = `item-select-${orderItemCounter}`;
            select.className = 'flex-grow p-2 rounded-lg input-style border border-gray-600 focus:ring-2 focus:ring-red-400';
            select.onchange = updateReceipt;

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '--- Speise auswÃ¤hlen ---';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);

            PRODUCTS.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.emoji} ${product.name} (${product.price.toFixed(2)} â‚¬)`;
                option.setAttribute('data-price', product.price);
                select.appendChild(option);
            });

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.id = `item-qty-${orderItemCounter}`;
            quantityInput.className = 'w-16 p-2 rounded-lg input-style border border-gray-600 text-center focus:ring-red-400';
            quantityInput.value = 1;
            quantityInput.min = 1;
            quantityInput.oninput = updateReceipt;
            
            const removeButton = document.createElement('button');
            removeButton.className = 'p-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex-shrink-0';
            removeButton.innerHTML = '&#x2715;'; 
            removeButton.title = 'Speise entfernen';
            removeButton.onclick = () => {
                itemRow.remove();
                updateReceipt();
            };

            itemRow.appendChild(select);
            itemRow.appendChild(quantityInput);
            itemRow.appendChild(removeButton);
            container.appendChild(itemRow);
            
            updateReceipt();
        }

        /**
         * Sammelt alle Bestelldaten und aktualisiert die Rechnung mit Rabatt.
         */
        function updateReceipt() {
            const receiptDetails = document.getElementById('receipt-details');
            const subTotalPriceSpan = document.getElementById('sub-total-price');
            const discountDiv = document.getElementById('receipt-discount');
            const discountAmountSpan = document.getElementById('discount-amount');
            const totalPriceSpan = document.getElementById('total-price');
            const pickupTimeInput = document.getElementById('pickup-time');
            const displayPickupTime = document.getElementById('display-pickup-time');
            const displayPaymentMethod = document.getElementById('display-payment-method');
            const itemContainer = document.getElementById('order-items-container');
            const sendBtn = document.getElementById('send-order-btn');
            
            let subTotalSum = 0;
            let receiptHTML = '';
            let itemCount = 0;

            Array.from(itemContainer.children).forEach(row => {
                const select = row.querySelector('select');
                const quantityInput = row.querySelector('input[type="number"]');

                const selectedOption = select.options[select.selectedIndex];
                const quantity = parseInt(quantityInput.value) || 0;
                
                if (selectedOption && selectedOption.value !== '' && quantity > 0) {
                    itemCount++;
                    const price = parseFloat(selectedOption.getAttribute('data-price'));
                    const nameWithEmoji = selectedOption.textContent.split(' (')[0].trim();
                    const name = nameWithEmoji.substring(nameWithEmoji.indexOf(' ')).trim(); 
                    const itemTotal = price * quantity;
                    subTotalSum += itemTotal;
                    
                    receiptHTML += `
                        <div class="flex justify-between border-b border-gray-700 pb-1">
                            <span class="flex-1">${quantity}x ${name}</span>
                            <span class="w-24 text-right">${price.toFixed(2).replace('.', ',')} â‚¬</span>
                            <span class="w-24 text-right font-semibold">${itemTotal.toFixed(2).replace('.', ',')} â‚¬</span>
                        </div>
                    `;
                }
            });

            if (itemCount === 0) {
                receiptHTML = '<p class="text-center italic text-gray-400">Noch keine Artikel in der Bestellung.</p>';
            }
            
            let discount = 0;
            let finalTotal = subTotalSum;
            const isFirstTime = isNewCustomer();
            
            if (isFirstTime && subTotalSum >= DISCOUNT_AMOUNT) { 
                discount = DISCOUNT_AMOUNT;
                finalTotal = subTotalSum - discount;
                
                discountDiv.style.display = 'flex';
                discountAmountSpan.textContent = '- ' + discount.toFixed(2).replace('.', ',') + ' â‚¬';
                document.getElementById('new-customer-banner').style.display = 'block';
            } else {
                if (isFirstTime && subTotalSum > 0) {
                     document.getElementById('new-customer-banner').style.display = 'block';
                } else if (!isFirstTime) {
                    document.getElementById('new-customer-banner').style.display = 'none';
                }
                discountDiv.style.display = 'none';
            }
            
            if (finalTotal < 0) finalTotal = 0;

            const pickupTime = pickupTimeInput.value;
            displayPickupTime.textContent = pickupTime ? pickupTime : 'Bitte auswÃ¤hlen';
            
            // Anzeige der Bezahlmethode und Button-Text anpassen
            const selectedPayment = document.querySelector('input[name="payment-method"]:checked');
            const paymentMethod = selectedPayment ? selectedPayment.value : 'Barzahlung';
            displayPaymentMethod.textContent = paymentMethod;

            if (paymentMethod === 'PayPal') {
                sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C6.54 2 2.08 6.47 2.08 11.97c0 1.63.4 3.23 1.18 4.67l-1.22 4.45 4.65-1.21c1.37.74 2.87 1.14 4.35 1.14 5.49 0 9.95-4.47 9.95-9.97C22 6.47 17.54 2 12.04 2zm5.82 14.86c-.19.46-.73.69-1.22.69-2.09 0-4.18-.74-5.82-2.22-.38-.34-.73-.72-1.04-1.12l-1.55-2.02c-.14-.19-.36-.26-.54-.18l-1.01.4c-.1.04-.13.06-.17.06-.21 0-.39-.12-.39-.34 0-1.78 1.4-3.2 3.1-3.2h.15c.19 0 .36.14.4.31l.5.76c.04.08.11.12.18.12.06 0 .12-.04.16-.08l1.09-1.34c.14-.17.39-.22.56-.13l1.83.95c.17.08.36.03.48-.1L17 11.44c.14-.19.1-.42-.1-.52l-1.7-1.1c-.2-.1-.4-.14-.62-.06l-1.46.36c-.19.04-.32-.05-.4-.22l-.46-1.12c-.08-.17-.25-.26-.44-.26h-.03c-2.47 0-4.48 2.01-4.48 4.48 0 1.2.47 2.37 1.34 3.22 1.45 1.3 3.14 1.94 4.88 1.94.85 0 1.63-.16 2.36-.5.19-.09.28-.3.2-.5z"/></svg>PayPal-Zahlung starten & senden';
            } else {
                 sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C6.54 2 2.08 6.47 2.08 11.97c0 1.63.4 3.23 1.18 4.67l-1.22 4.45 4.65-1.21c1.37.74 2.87 1.14 4.35 1.14 5.49 0 9.95-4.47 9.95-9.97C22 6.47 17.54 2 12.04 2zm5.82 14.86c-.19.46-.73.69-1.22.69-2.09 0-4.18-.74-5.82-2.22-.38-.34-.73-.72-1.04-1.12l-1.55-2.02c-.14-.19-.36-.26-.54-.18l-1.01.4c-.1.04-.13.06-.17.06-.21 0-.39-.12-.39-.34 0-1.78 1.4-3.2 3.1-3.2h.15c.19 0 .36.14.4.31l.5.76c.04.08.11.12.18.12.06 0 .12-.04.16-.08l1.09-1.34c.14-.17.39-.22.56-.13l1.83.95c.17.08.36.03.48-.1L17 11.44c.14-.19.1-.42-.1-.52l-1.7-1.1c-.2-.1-.4-.14-.62-.06l-1.46.36c-.19.04-.32-.05-.4-.22l-.46-1.12c-.08-.17-.25-.26-.44-.26h-.03c-2.47 0-4.48 2.01-4.48 4.48 0 1.2.47 2.37 1.34 3.22 1.45 1.3 3.14 1.94 4.88 1.94.85 0 1.63-.16 2.36-.5.19-.09.28-.3.2-.5z"/></svg>Per WhatsApp senden (Barzahlung)';
            }

            receiptDetails.innerHTML = receiptHTML;
            subTotalPriceSpan.textContent = subTotalSum.toFixed(2).replace('.', ',') + ' â‚¬';
            totalPriceSpan.textContent = finalTotal.toFixed(2).replace('.', ',') + ' â‚¬';
        }

        /**
         * Hauptfunktion zum Starten der Bestellung (Ã¶ffnet Modal bei PayPal)
         */
        function handleOrderSubmission() {
            const validationResult = validateOrder(false);
            if (validationResult !== true) {
                showMessage(validationResult);
                return;
            }
            
            const selectedPayment = document.querySelector('input[name="payment-method"]:checked').value;
            
            if (selectedPayment === 'PayPal') {
                openPaypalModal();
            } else {
                // Barzahlung
                sendOrderViaWhatsApp('Barzahlung');
            }
        }
        
        /**
         * Ã–ffnet das PayPal-Modal und generiert den Link.
         */
        function openPaypalModal() {
            const finalTotalStr = document.getElementById('total-price').textContent;
            const finalTotal = parseFloat(finalTotalStr.replace('â‚¬', '').replace(',', '.').trim());
            
            let paypalLink;
            let isTestMode = PAYPAL_ME_NAME === 'TEST_MODE_DEAKTIVIERT';

            if (isTestMode) {
                // Test-Link-Logik
                paypalLink = `${PAYPAL_TEST_LINK_BASE}${finalTotal.toFixed(2).replace('.', ',')}`;
                document.getElementById('test-mode-info').style.display = 'block';

            } else {
                // Live-Link-Logik
                paypalLink = `https://paypal.me/${PAYPAL_ME_NAME}/${finalTotal.toFixed(2).replace('.', ',')}`;
                document.getElementById('test-mode-info').style.display = 'none';
            }

            document.getElementById('modal-total-price').textContent = finalTotalStr;
            document.getElementById('paypal-link').href = paypalLink;
            document.getElementById('modal-link-display').textContent = paypalLink;
            
            document.getElementById('paypal-modal').style.display = 'flex';
        }
        
        /**
         * SchlieÃŸt das PayPal-Modal.
         */
        function closePaypalModal() {
            document.getElementById('paypal-modal').style.display = 'none';
        }


        /**
         * Generiert den vollstÃ¤ndigen Bestelltext.
         */
        function generateOrderText(paymentMethod) {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const pickupTime = document.getElementById('pickup-time').value.trim();
            const finalTotalStr = document.getElementById('total-price').textContent;
            const subTotal = document.getElementById('sub-total-price').textContent;
            
            const isDiscountApplied = isNewCustomer() && parseFloat(subTotal.replace(',', '.')) >= DISCOUNT_AMOUNT;
            
            const discountText = isDiscountApplied 
                ? `\n(INKLUSIVE 1,50 â‚¬ Neukunden-Rabatt! Ersparnis: ${DISCOUNT_AMOUNT.toFixed(2).replace('.', ',')} â‚¬)` 
                : '';

            const lineBreak = '\n'; 
            let itemsText = [];
            const itemContainer = document.getElementById('order-items-container');
            
            Array.from(itemContainer.children).forEach(row => {
                const select = row.querySelector('select');
                const quantityInput = row.querySelector('input[type="number"]');
                const selectedOption = select.options[select.selectedIndex];
                const quantity = parseInt(quantityInput.value) || 0;
                
                if (selectedOption && selectedOption.value !== '' && quantity > 0) {
                    const nameWithEmoji = selectedOption.textContent.split(' (')[0].trim();
                    const name = nameWithEmoji.substring(nameWithEmoji.indexOf(' ')).trim(); 
                    itemsText.push(`* ${quantity}x ${name}`);
                }
            });

            if (itemsText.length === 0) { return 'Fehler: Keine Speisen ausgewÃ¤hlt.'; } 

            let paymentNote = '';
            let displayedPayment = '';

            if (paymentMethod === 'PayPal') {
                paymentNote = `${lineBreak}*HINWEIS: Die Zahlung wurde vorab per PayPal gestartet. Bitte prÃ¼fen Sie den Zahlungseingang!*`;
                displayedPayment = 'PayPal (Vorkasse, gestartet)';
            } else if (paymentMethod === 'Barzahlung_Fallback') {
                paymentNote = `${lineBreak}*HINWEIS: Kunde hat PayPal abgebrochen und wÃ¤hlt Barzahlung bei Abholung.*`;
                displayedPayment = 'Barzahlung (PayPal-Fallback)';
            } else { // 'Barzahlung'
                 paymentNote = `${lineBreak}*HINWEIS: Zahlung erfolgt bar bei Abholung.*`;
                 displayedPayment = 'Barzahlung';
            }


            const orderText = `*Neue Bestellung - Mampfy Crazy Mexican*${lineBreak}${lineBreak}` +
                             `*Kunde:*${lineBreak}` +
                             `Name: ${name}${lineBreak}` +
                             `Telefon: ${phone}${lineBreak}` +
                             `${lineBreak}*Abholzeit:*${lineBreak}` +
                             `${pickupTime}${lineBreak}${lineBreak}` +
                             `*Bezahlmethode:* ${displayedPayment}${lineBreak}` +
                             `${lineBreak}*Bestellte Speisen:*${lineBreak}` +
                             itemsText.join(lineBreak) +
                             `${lineBreak}${lineBreak}` +
                             (isDiscountApplied ? `Zwischensumme: ${subTotal}${lineBreak}Rabatt: - ${DISCOUNT_AMOUNT.toFixed(2).replace('.', ',')} â‚¬${lineBreak}` : '') +
                             `*Gesamtsumme (Endpreis):*${lineBreak}` +
                             `${finalTotalStr}${discountText}` +
                             paymentNote +
                             `${lineBreak}${lineBreak}Vielen Dank!`;
                             
            return orderText;
        }
        
        /**
         * FÃ¼hrt die WhatsApp-Bestellung aus und setzt das Neukunden-Flag.
         * @param {string} finalPaymentMethod - Barzahlung, PayPal oder Barzahlung_Fallback
         */
        function sendOrderViaWhatsApp(finalPaymentMethod) {
            
            closePaypalModal();

            const orderText = generateOrderText(finalPaymentMethod); 

            if (orderText && typeof orderText === 'string') {
                const whatsappUrl = `https://wa.me/${phoneRecipient}?text=${encodeURIComponent(orderText)}`;
                window.open(whatsappUrl, '_blank');
                
                if (isNewCustomer()) {
                    localStorage.setItem(NEW_CUSTOMER_FLAG, 'ordered');
                }

                // Nachricht an den Kunden
                let successMsg = `Bestellung (${finalPaymentMethod.replace('_Fallback', '')}) via WhatsApp erstellt. Bitte in WhatsApp auf "Senden" klicken.`;
                if (finalPaymentMethod === 'PayPal') {
                    successMsg += " Bitte vergessen Sie nicht, die Zahlung in dem geÃ¶ffneten PayPal-Fenster abzuschlieÃŸen.";
                }
                showMessage(successMsg, 'success');
            }
        }
        
        async function shareApp() {
            const shareData = {
                title: 'Mampfy Crazy Mexican Bestell-App',
                text: 'Bestelle jetzt online mit 1,50 â‚¬ Neukunden-Rabatt bei Mampfy Crazy Mexican!', 
                url: SHARE_URL,
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    const fallbackText = `Probier die neue Mampfy Crazy Mexican Bestell-App aus und sichere dir 1,50 â‚¬ Neukunden-Rabatt: ${SHARE_URL}`;
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(fallbackText)}`;
                    window.open(whatsappUrl, '_blank');
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showMessage('Teilen fehlgeschlagen: ' + err, 'error');
                }
            }
        }

        /**
         * PrÃ¼ft, ob alle Pflichtfelder ausgefÃ¼llt sind.
         */
        function validateOrder() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const pickupTime = document.getElementById('pickup-time').value.trim(); 
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked'); 
            
            let hasValidItems = false;
            const itemContainer = document.getElementById('order-items-container');
            Array.from(itemContainer.children).forEach(row => {
                const select = row.querySelector('select');
                const quantityInput = row.querySelector('input[type="number"]');
                const selectedOption = select.options[select.selectedIndex];
                const quantity = parseInt(quantityInput.value) || 0;
                
                if (selectedOption && selectedOption.value !== '' && quantity > 0) {
                    hasValidItems = true;
                }
            });

            if (!name) { return 'Bitte geben Sie Ihren Namen ein.'; }
            if (!phone) { return 'Bitte geben Sie Ihre Telefonnummer ein.'; }
            if (!pickupTime) { return 'Bitte geben Sie die gewÃ¼nschte Abholzeit ein.'; } 
            if (!paymentMethod) { return 'Bitte wÃ¤hlen Sie eine Bezahlmethode aus.'; }
            if (!hasValidItems) { return 'Bitte fÃ¼gen Sie mindestens eine Speise hinzu.'; }

            return true;
        }

        document.getElementById('pickup-time').addEventListener('input', updateReceipt);
        document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
            radio.addEventListener('change', updateReceipt);
        });
        
        function initializeApp() {
            addDish(); 
        }

        window.onload = initializeApp;
        
    </script>
</body>
</html>
